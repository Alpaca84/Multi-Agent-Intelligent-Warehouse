version: "3.9"

services:
  # ==========================================
  # Database (TimescaleDB / PostgreSQL)
  # ==========================================
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: warehouse-postgres-prod
    restart: always
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-warehouse}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-warehouse}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
      - ../../data/postgres:/docker-entrypoint-initdb.d
    ports:
      # Expose for migration scripts (optional in strict prod, but useful)
      - "${DB_PORT:-5435}:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-warehouse}" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Caching & Queue (Redis)
  # ==========================================
  redis:
    image: redis:7-alpine
    container_name: warehouse-redis-prod
    restart: always
    volumes:
      - redis_data_prod:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Vector Database (Milvus)
  # ==========================================
  milvus:
    image: milvusdb/milvus:v2.3.0
    container_name: warehouse-milvus-prod
    restart: always
    environment:
      - ETCD_USE_EMBED=true
      - ETCD_DATA_DIR=/var/lib/milvus/etcd
      - COMMON_STORAGETYPE=local
    volumes:
      - milvus_data_prod:/var/lib/milvus
    ports:
      - "19530:19530"
    command: [ "milvus", "run", "standalone" ]
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9091/healthz" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # API / Backend
  # ==========================================
  chain_server:
    build:
      context: ../../
      dockerfile: Dockerfile
    container_name: warehouse-api-prod
    restart: always
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
      milvus:
        condition: service_healthy
    ports:
      - "${API_PORT:-8001}:8001"
    environment:
      - ENVIRONMENT=production
      - DATABASE_URL=postgresql://${POSTGRES_USER:-warehouse}:${POSTGRES_PASSWORD:-changeme}@timescaledb:5432/${POSTGRES_DB:-warehouse}
      - PGHOST=timescaledb
      - PGPORT=5432
      - POSTGRES_USER=${POSTGRES_USER:-warehouse}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - POSTGRES_DB=${POSTGRES_DB:-warehouse}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      # API Keys & External Services (Passed from .env)
      - NVIDIA_API_KEY=${NVIDIA_API_KEY}
      - LLM_NIM_URL=${LLM_NIM_URL:-https://api.brev.dev/v1}
      - EMBEDDING_NIM_URL=${EMBEDDING_NIM_URL:-https://integrate.api.nvidia.com/v1}
      - NEMO_RETRIEVER_URL=${NEMO_RETRIEVER_URL:-https://integrate.api.nvidia.com/v1}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD:-changeme}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:${FRONTEND_PORT:-3000},http://localhost:3001}
    volumes:
      # Mount data directory for persistence/logs if needed
      - ../../data:/app/data
      - ../../logs:/app/logs

  # ==========================================
  # Frontend
  # ==========================================
  frontend:
    build:
      context: ../../
      dockerfile: deploy/docker/frontend.Dockerfile
      args:
        # Pass build-time variables (REACT_APP_...)
        - REACT_APP_API_URL=http://localhost:${API_PORT:-8001}
        # In production, API URL might need to be the public IP/Domain
    container_name: warehouse-frontend-prod
    restart: always
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      - chain_server

volumes:
  postgres_data_prod:
  redis_data_prod:
  milvus_data_prod:
